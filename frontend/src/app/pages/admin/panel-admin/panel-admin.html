<app-header-admin></app-header-admin>

<main>
  <div class="dashboard-container">
    <div class="metrics" *ngIf="activeTab === 'productos'">
      <div class="card">
        <h3>Total Cat√°logo</h3>
        <span class="value">{{ products.length }}</span>
      </div>
      <div class="card">
        <h3>Activos (Venta)</h3>
        <span class="value" style="color: #28a745">{{ productosActivos }}</span>
      </div>
      <div class="card">
        <h3>Descontinuados</h3>
        <span class="value" style="color: #6c757d">{{ productosInactivos }}</span>
      </div>
      <div class="card">
        <h3>Categor√≠as</h3>
        <span class="value">{{ categorias.length }}</span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'categorias'">
      <div class="card">
        <h3>Total Categor√≠as</h3>
        <span class="value">{{ categorias.length }}</span>
      </div>
      <div class="card">
        <h3>Activas</h3>
        <span class="value text-success"> {{ categoriasActivas }} </span>
      </div>
      <div class="card">
        <h3>Inactivas</h3>
        <span class="value text-danger"> {{ categoriasInactivas }} </span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'inventario'">
      <div class="card">
        <h3>Total Productos</h3>
        <span class="value">{{ products.length }}</span>
      </div>
      <div class="card">
        <h3>Stock Cr√≠tico</h3>
        <span class="value" [class.alert]="stockBajo > 0">{{ stockBajo }}</span>
      </div>
      <div class="card">
        <h3>Stock Saludable</h3>
        <span class="value" style="color: #1e8e3e">{{ products.length - stockBajo }}</span>
      </div>
      <div class="card">
        <h3>Estado Almac√©n</h3>
        <span class="value" style="font-size: 25px">{{
          stockBajo > 0 ? '‚ö†Ô∏è Atenci√≥n' : '‚úÖ √ìptimo'
        }}</span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'ventas'">
      <div class="card">
        <h3>Ingresos Totales</h3>
        <span class="value">{{ ingresosTotales | currency : 'S/. ' : 'symbol' : '1.2-2' }}</span>
      </div>
      <div class="card">
        <h3>Total Transacciones</h3>
        <span class="value">{{ ventasTotales }}</span>
      </div>
      <div class="card">
        <h3>Ventas Procesadas</h3>
        <span class="value" [style.color]="ventasProcesadas > 0 ? '#28a745' : '#666'">
          {{ ventasProcesadas }}
        </span>
      </div>
      <div class="card">
        <h3>Promedio por Venta</h3>
        <span class="value">{{ ticketPromedio | currency : 'S/. ' : 'symbol' : '1.0-0' }}</span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'ubicaciones'">
      <div class="card">
        <h3>Vista Actual</h3>
        <span class="value" style="font-size: 1.2rem; text-transform: capitalize">
          {{
            nivelUbicacion === 'DEPTO'
              ? 'Departamentos'
              : nivelUbicacion === 'PROV'
              ? 'Provincias'
              : 'Distritos'
          }}
        </span>
      </div>
      <div class="card">
        <h3>Total Listado</h3>
        <span class="value">{{ metricsUbicacion.total }}</span>
      </div>
      <div class="card">
        <h3>Habilitados</h3>
        <span class="value" style="color: #28a745">{{ metricsUbicacion.activos }}</span>
      </div>
      <div class="card">
        <h3>Deshabilitados</h3>
        <span class="value" style="color: #dc3545">{{ metricsUbicacion.inactivos }}</span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'envios'">
      <ng-container *ngIf="!agenciaSeleccionada">
        <div class="card">
          <h3>Agencias Registradas</h3>
          <span class="value">{{ agencias.length }}</span>
        </div>
        <div class="card">
          <h3>Agencias Activas</h3>
          <span class="value" style="color: #28a745">
            <span class="value" style="color: #28a745">
              {{ agenciasActivasCount }}
            </span>
          </span>
        </div>
        <div class="card">
          <h3>Agencias Inactivas</h3>
          <span class="value">
            <span class="value" style="color: #dc3545">
              {{ agencias.length - agenciasActivasCount }}
            </span>
          </span>
        </div>
        <div class="card">
          <h3>Seleccione</h3>
          <span class="value" style="font-size: 1rem; color: #666">una Agencia</span>
        </div>
      </ng-container>

      <ng-container *ngIf="agenciaSeleccionada">
        <div class="card">
          <h3>Agencia Actual</h3>
          <span class="value" style="font-size: 1.2rem; color: #f97316">{{
            agenciaSeleccionada.nombre
          }}</span>
        </div>
        <div class="card">
          <h3>Rutas/Tarifas</h3>
          <span class="value">{{ metricsEnvios.rutasActivas }}</span>
        </div>
        <div class="card">
          <h3>Costo Promedio</h3>
          <span class="value">{{ metricsEnvios.costoProm | currency : 'S/. ' }}</span>
        </div>
        <div class="card">
          <h3>Tiempo Promedio</h3>
          <span class="value">{{ metricsEnvios.tiempoProm | number : '1.0-1' }} d√≠as</span>
        </div>
      </ng-container>
    </div>

    <div class="metrics" *ngIf="activeTab === 'pedidos'">
      <div
        class="card"
        [style.border-left]="metricsPedidos.pendientes > 0 ? '4px solid #f97316' : ''"
      >
        <h3>üîî Por Atender</h3>
        <span class="value" [style.color]="metricsPedidos.pendientes > 0 ? '#f97316' : '#666'">
          {{ metricsPedidos.pendientes }}
        </span>
      </div>

      <div class="card">
        <h3>üì¶ Por Despachar</h3>
        <span class="value" style="color: #0ea5e9">{{ metricsPedidos.porDespachar }}</span>
      </div>

      <div class="card">
        <h3>üöö En Ruta</h3>
        <span class="value" style="color: #8b5cf6">{{ metricsPedidos.enRuta }}</span>
      </div>

      <div class="card">
        <h3>üí∞ Venta Hoy</h3>
        <span class="value" style="color: #28a745">
          {{ metricsPedidos.totalDia | currency : 'S/. ' }}
        </span>
      </div>
    </div>

    <div class="tabs">
      <button
        class="tab"
        [class.active]="activeTab === 'productos'"
        (click)="cambiarTab('productos')"
      >
        Productos
      </button>

      <button
        class="tab"
        [class.active]="activeTab === 'inventario'"
        (click)="cambiarTab('inventario')"
      >
        Inventario
      </button>

      <button
        class="tab"
        [class.active]="activeTab === 'categorias'"
        (click)="cambiarTab('categorias')"
      >
        Categor√≠as
      </button>

      <button class="tab" [class.active]="activeTab === 'ventas'" (click)="cambiarTab('ventas')">
        Ventas
      </button>

      <button
        class="tab"
        [class.active]="activeTab === 'ubicaciones'"
        (click)="cambiarTab('ubicaciones')"
      >
        Ubicaciones
      </button>

      <button class="tab" [class.active]="activeTab === 'envios'" (click)="cambiarTab('envios')">
        Env√≠os
      </button>

      <button class="tab" [class.active]="activeTab === 'pedidos'" (click)="cambiarTab('pedidos')">
        Pedidos
      </button>
    </div>

    <div *ngIf="activeTab === 'productos'" class="table-section">
      <div class="table-header">
        <h3>Listado de Productos</h3>
        <button class="btn add" (click)="abrirModalAgregarProducto()">+ Nuevo Producto</button>
      </div>

      <div class="filters-bar">
        <div class="filter-group">
          <input
            type="text"
            placeholder="Buscar producto por nombre..."
            [(ngModel)]="filtroNombre"
            (keyup.enter)="filtrarProductos()"
          />
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroCategoria" (change)="filtrarProductos()">
            <option [ngValue]="null">Todas las Categor√≠as</option>
            <option *ngFor="let cat of categorias" [ngValue]="cat.id">
              {{ cat.nombre }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroEstado" (change)="filtrarProductos()">
            <option value="">Todos los Estados</option>
            <option value="ACTIVO">Activo</option>
            <option value="DESCONTINUADO">Descontinuado</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn-filter clear" (click)="limpiarFiltros()" title="Limpiar filtros">
            ‚úï
          </button>
        </div>
      </div>

      <table class="products-table" *ngIf="!cargando">
        <thead>
          <tr>
            <th>Img</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of products">
            <td>
              <img
                [src]="p.imagenUrl"
                onerror="this.src='/img/placeholder.png'"
                class="table-img"
              />
            </td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.categoriaNombre || 'Sin Cat.' }}</td>
            <td>{{ p.precio | currency : 'S/. ' : 'symbol' : '1.2-2' }}</td>
            <td>
              <span [class.text-danger]="p.stockActual < p.stockMinimo">
                {{ p.stockActual }}
              </span>
            </td>
            <td>
              <span class="status" [ngClass]="p.estado === 'ACTIVO' ? 'normal' : 'low'">
                {{ p.estado }}
              </span>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button
                  class="btn-icon btn-blue"
                  (click)="abrirModalStock(p)"
                  title="Ajustar Stock"
                >
                  üì¶
                </button>

                <button
                  class="btn-icon btn-yellow"
                  (click)="abrirModalEditarProducto(p)"
                  title="Editar"
                >
                  ‚úèÔ∏è
                </button>

                <button
                  class="btn-icon btn-gray"
                  *ngIf="p.estado === 'ACTIVO'"
                  (click)="desactivarProducto(p.id)"
                  title="Desactivar"
                >
                  üîí
                </button>

                <button
                  class="btn-icon btn-green"
                  *ngIf="p.estado !== 'ACTIVO'"
                  (click)="activarProducto(p.id)"
                  title="Activar"
                >
                  üîì
                </button>

                <button class="btn-icon btn-red" (click)="eliminarProducto(p.id)" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'categorias'" class="table-section relative-container">
      <div class="table-header">
        <h3>Gesti√≥n de Categor√≠as</h3>
        <button class="btn add" (click)="abrirModalCategoria()">+ Nueva Categor√≠a</button>
      </div>

      <div *ngIf="cargando" class="loading-overlay">
        <div class="spinner"></div>
      </div>

      <table class="products-table">
        <thead>
          <tr>
            <th style="width: 50px">ID</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Estado</th>
            <th class="text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of categorias">
            <td class="fw-bold">#{{ c.id }}</td>

            <td style="font-weight: 600; color: var(--text-main)">
              {{ c.nombre }}
            </td>

            <td style="color: var(--text-muted); font-size: 0.85rem; max-width: 300px">
              {{ c.descripcion || '‚Äî' }}
            </td>

            <td>
              <span class="status" [ngClass]="c.estado === 'ACTIVO' ? 'normal' : 'low'">
                {{ c.estado }}
              </span>
            </td>

            <td class="text-right">
              <div class="action-buttons">
                <button class="btn-icon btn-yellow" (click)="abrirModalCategoria(c)" title="Editar">
                  ‚úèÔ∏è
                </button>

                <button
                  class="btn-icon btn-gray"
                  *ngIf="c.estado === 'ACTIVO'"
                  (click)="desactivarCategoria(c.id)"
                  title="Desactivar"
                >
                  üîí
                </button>

                <button
                  class="btn-icon btn-green"
                  *ngIf="c.estado !== 'ACTIVO'"
                  (click)="activarCategoria(c.id)"
                  title="Activar"
                >
                  üîì
                </button>

                <button
                  class="btn-icon btn-red"
                  (click)="eliminarCategoria(c.id)"
                  title="Eliminar Permanentemente"
                >
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="categorias.length === 0 && !cargando">
            <td colspan="5" class="text-center" style="padding: 40px; color: #999">
              No hay categor√≠as registradas.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'inventario'" class="table-section">
      <div class="table-header">
        <h3>Control de Stock</h3>

        <label class="toggle-filter" [class.active]="mostrarSoloBajoStock">
          <input type="checkbox" [(ngModel)]="mostrarSoloBajoStock" />
          ‚ö†Ô∏è Ver solo Stock Bajo
        </label>
      </div>

      <table class="products-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock Actual</th>
            <th>M√≠nimo Req.</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of inventarioFiltrado">
            <td>{{ p.nombre }}</td>
            <td style="font-weight: bold; font-size: 1.1em">
              <span [class.text-danger]="p.stockActual < p.stockMinimo">
                {{ p.stockActual }}
              </span>
            </td>
            <td>{{ p.stockMinimo }}</td>
            <td>
              <span class="status" [ngClass]="p.stockActual < p.stockMinimo ? 'low' : 'normal'">
                {{ p.stockActual < p.stockMinimo ? 'REPONER' : 'OK' }}
              </span>
            </td>
          </tr>

          <tr *ngIf="inventarioFiltrado.length === 0 && mostrarSoloBajoStock">
            <td colspan="4" style="text-align: center; padding: 20px; color: #1e8e3e">
              ‚úÖ ¬°Todo est√° en orden! No hay productos con stock bajo.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'ventas'" class="table-section">
      <div class="table-header">
        <h3>Historial de Transacciones</h3>

        <button class="btn add" (click)="abrirModalVenta()">+ Nueva Venta Interna</button>
      </div>

      <div class="filters-bar">
        <div class="filter-group">
          <input
            type="text"
            placeholder="Buscar por DNI Cliente..."
            [(ngModel)]="filtroVentaDni"
            (keyup.enter)="filtrarVentas()"
          />
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroVentaCanal" (change)="filtrarVentas()">
            <option value="">Todos los Canales</option>
            <option value="ONLINE">Online (Web)</option>
            <option value="INTERNO">Interno (Local/Distribuidor)</option>
          </select>
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroVentaEstado" (change)="filtrarVentas()">
            <option value="">Todos los Estados</option>
            <option value="PAGADA">Pagada</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="PROCESADA">Procesada</option>
            <option value="CANCELADA">Cancelada</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn-filter clear" (click)="limpiarFiltrosVentas()">‚úï</button>
        </div>
      </div>
      <table class="products-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente (DNI)</th>
            <th>Canal</th>
            <th>Total</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Reporte</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let v of ventasFiltradas">
            <td>#{{ v.id }}</td>

            <td>
              <div style="display: flex; flex-direction: column">
                <span style="font-weight: 500">{{
                  v.nombresUsuario + ' ' + v.apellidosUsuario || 'Cliente'
                }}</span>
                <small style="color: #d48300; font-weight: bold">
                  {{ v.dniUsuario || 'S/N' }}
                </small>
              </div>
            </td>

            <td>
              <span style="font-size: 11px; padding: 2px 6px; background: #eee; border-radius: 4px">
                {{ v.canal }}
              </span>
            </td>

            <td style="font-weight: bold">
              {{ v.montoTotal | currency : 'S/. ' : 'symbol' : '1.2-2' }}
            </td>
            <td>{{ v.fecha | date : 'short' }}</td>
            <td>
              <span
                class="status"
                [ngClass]="v.estado === 'PAGADA' || v.estado === 'PROCESADA' ? 'normal' : 'low'"
              >
                {{ v.estado }}
              </span>
            </td>
            <td>
              <button class="btn-reporte" title="Descargar PDF" (click)="generarReporte(v.id)">
                üìÑ PDF
              </button>
            </td>
          </tr>
          <tr *ngIf="ventasFiltradas.length === 0">
            <td colspan="6" style="text-align: center; padding: 20px; color: #666">
              No se encontraron ventas con estos filtros.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'ubicaciones'" class="table-section relative-container">
      <div class="table-header">
        <div style="display: flex; align-items: center; gap: 10px">
          <button
            *ngIf="nivelUbicacion !== 'DEPTO'"
            (click)="volverNivel()"
            class="btn-icon"
            style="background: #eee"
          >
            ‚¨Ö
          </button>

          <h3 *ngIf="nivelUbicacion === 'DEPTO'">Departamentos</h3>
          <h3 *ngIf="nivelUbicacion === 'PROV'">Provincias de {{ padreSeleccionado?.nombre }}</h3>
          <h3 *ngIf="nivelUbicacion === 'DIST'">Distritos de {{ padreSeleccionado?.nombre }}</h3>
        </div>

        <button class="btn add" (click)="abrirModalCrearUbicacion()">
          + Nuevo
          {{
            nivelUbicacion === 'DEPTO'
              ? 'Departamento'
              : nivelUbicacion === 'PROV'
              ? 'Provincia'
              : 'Distrito'
          }}
        </button>
      </div>

      <table class="products-table">
        <thead>
          <tr>
            <th>ID</th>
            <th style="text-align: left">Nombre</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of listaUbicacion">
            <td>{{ item.id }}</td>
            <td style="text-align: left; font-weight: 500">{{ item.nombre }}</td>
            <td>
              <span class="status" [ngClass]="item.estado === 'ACTIVO' ? 'normal' : 'low'">
                {{ item.estado }}
              </span>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button
                  class="btn-icon btn-blue"
                  *ngIf="nivelUbicacion !== 'DIST'"
                  (click)="nivelUbicacion === 'DEPTO' ? verProvincias(item) : verDistritos(item)"
                  title="Ver contenido"
                >
                  üìÇ
                </button>

                <button
                  class="btn-icon btn-gray"
                  *ngIf="item.estado === 'ACTIVO'"
                  (click)="cambiarEstadoUbicacion(item, 'desactivar')"
                  title="Desactivar"
                >
                  üîí
                </button>

                <button
                  class="btn-icon btn-green"
                  *ngIf="item.estado !== 'ACTIVO'"
                  (click)="cambiarEstadoUbicacion(item, 'activar')"
                  title="Activar"
                >
                  üîì
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="listaUbicacion.length === 0">
            <td colspan="4" style="text-align: center; padding: 20px">
              No hay registros en este nivel.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'envios'" class="logistica-grid">
      <div class="panel-col">
        <div class="table-header">
          <h3>Agencias</h3>
          <button
            class="btn-icon btn-green"
            (click)="mostrarModalAgencia = true"
            title="Nueva Agencia"
          >
            +
          </button>
        </div>

        <ul class="agencia-list">
          <li
            *ngFor="let ag of agencias"
            [class.selected]="agenciaSeleccionada?.id === ag.id"
            (click)="verTarifas(ag)"
          >
            <div style="display: flex; align-items: center; gap: 8px">
              <span
                class="dot"
                [class.active]="ag.estado === 'ACTIVO'"
                [class.inactive]="ag.estado !== 'ACTIVO'"
              ></span>
              <span>{{ ag.nombre }}</span>
            </div>

            <div style="display: flex; gap: 5px">
              <button
                class="btn-icon small"
                [class.btn-green]="ag.estado !== 'ACTIVO'"
                [class.btn-gray]="ag.estado === 'ACTIVO'"
                (click)="toggleEstadoAgencia(ag); $event.stopPropagation()"
                [title]="ag.estado === 'ACTIVO' ? 'Desactivar' : 'Activar'"
              >
                {{ ag.estado === 'ACTIVO' ? 'üîí' : 'üîì' }}
              </button>

              <button
                class="btn-icon btn-red small"
                (click)="eliminarAgencia(ag.id); $event.stopPropagation()"
                title="Eliminar"
              >
                ‚úï
              </button>
            </div>
          </li>
        </ul>
      </div>

      <div class="panel-col">
        <div class="table-header">
          <h3>Tarifas {{ agenciaSeleccionada ? 'de ' + agenciaSeleccionada.nombre : '' }}</h3>
          <button class="btn add" (click)="abrirModalTarifa()" [disabled]="!agenciaSeleccionada">
            + Nueva Tarifa
          </button>
        </div>

        <div *ngIf="!agenciaSeleccionada" class="empty-state">
          Seleccione una agencia para ver sus tarifas.
        </div>

        <table class="products-table" *ngIf="agenciaSeleccionada">
          <thead>
            <tr>
              <th>Departamento</th>
              <th>Provincia</th>
              <th>Distrito</th>
              <th>Costo</th>
              <th>Tiempo</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of tarifas">
              <td>{{ t.departamentoDistrito }}</td>
              <td>{{ t.provinciaDistrito }}</td>
              <td style="font-weight: bold; color: #333">{{ t.nombreDistrito }}</td>

              <td style="color: #d48300; font-weight: bold">
                S/ {{ t.costoEnvio | number : '1.2-2' }}
              </td>
              <td>{{ t.diasEstimados }} d√≠as</td>

              <td>
                <span class="status" [ngClass]="t.estado === 'ACTIVO' ? 'normal' : 'low'">
                  {{ t.estado }}
                </span>
              </td>

              <td class="actions-cell">
                <div class="action-buttons">
                  <button
                    class="btn-icon btn-gray"
                    *ngIf="t.estado === 'ACTIVO'"
                    (click)="desactivarTarifa(t.id)"
                    title="Desactivar"
                  >
                    üîí
                  </button>

                  <button
                    class="btn-icon btn-green"
                    *ngIf="t.estado !== 'ACTIVO'"
                    (click)="activarTarifa(t.id)"
                    title="Activar"
                  >
                    üîì
                  </button>

                  <button class="btn-icon btn-red" (click)="eliminarTarifa(t.id)" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="tarifas.length === 0">
              <td colspan="7" style="text-align: center; padding: 40px; color: #777">
                Esta agencia no tiene tarifas registradas.<br />
                ¬°Agrega una para empezar a vender!
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div *ngIf="activeTab === 'pedidos'" class="full-width-layout">
      <div class="panel-col">
        <div class="table-header orders-header">
          <div class="header-title">
            <h3>Gesti√≥n de Pedidos</h3>
            <p>Administra y despacha las compras</p>
          </div>

          <div class="orders-toolbar">
            <div class="search-wrapper">
              <input
                type="text"
                class="form-control search-input"
                placeholder="Buscar cliente..."
                [(ngModel)]="filtroUsuario"
                (input)="aplicarFiltros()"
              />
            </div>

            <select
              class="form-control filter-select"
              [(ngModel)]="filtroEstado"
              (change)="aplicarFiltros()"
            >
              <option value="TODOS">Todos los estados</option>
              <option *ngFor="let est of estadosPosibles" [value]="est">{{ est }}</option>
            </select>

            <button class="btn-icon" (click)="cargarPedidos()" title="Actualizar">‚Üª</button>
          </div>
        </div>

        <div class="table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th class="col-id">ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total</th>
                <th class="col-status">Estado</th>
                <th class="col-actions">Detalles</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of pedidosFiltrados">
                <td class="fw-bold">#{{ p.id }}</td>
                <td>{{ p.fechaRegistro | date : 'dd/MM/yy HH:mm' }}</td>
                <td>
                  <div class="client-name">{{ p.nombresUsuario }} {{ p.apellidosUsuario }}</div>
                  <div class="client-email">{{ p.emailUsuario }}</div>
                </td>
                <td class="fw-bold">S/ {{ p.total | number : '1.2-2' }}</td>

                <td class="text-center">
                  <select
                    [ngModel]="p.estado"
                    (ngModelChange)="cambiarEstado(p, $event)"
                    class="status-select"
                    [ngClass]="{
                      pending: p.estado === 'PENDIENTE',
                      paid: p.estado === 'EN_PREPARACION',
                      shipped: p.estado === 'EN_REPARTO',
                      canceled: p.estado === 'CANCELADO'
                    }"
                  >
                    <option *ngFor="let est of estadosPosibles" [value]="est">{{ est }}</option>
                  </select>
                </td>

                <td class="col-actions">
                  <button class="btn-icon" (click)="verDetallePedido(p)" title="Ver Productos">
                    <img class="info-icon" src="/img/informacion.png" alt="Ver" />
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="pedidosFiltrados.length === 0" class="empty-state">
            <p>No se encontraron pedidos con los filtros actuales.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="modal-overlay" *ngIf="mostrarModal">
  <div class="modal-container">
    <h2 class="modal-title">
      {{ idEdicion ? 'Editar Producto' : 'Registrar Nuevo Producto' }}
    </h2>

    <form [formGroup]="formProducto" class="modal-form">
      <div class="form-group">
        <label>Nombre del Producto</label>
        <input formControlName="nombre" type="text" placeholder="Ej. Miel de Eucalipto" />
      </div>

      <div class="form-group">
        <label>Categor√≠a</label>
        <select formControlName="idCategoria">
          <option [ngValue]="''" disabled>-- Seleccione --</option>

          <option *ngFor="let cat of categorias" [ngValue]="cat.id">
            {{ cat.nombre }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea formControlName="descripcion" rows="3"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group small">
          <label>Precio (S/)</label>
          <input formControlName="precio" type="number" min="0" />
        </div>
        <div class="form-group small">
          <label>Precio Interno (S/)</label>
          <input formControlName="precioInterno" type="number" min="0" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group small">
          <label>Stock Inicial</label>
          <input formControlName="stockActual" type="number" min="0" />
        </div>
        <div class="form-group small">
          <label>Stock M√≠nimo (Alerta)</label>
          <input formControlName="stockMinimo" type="number" min="0" />
        </div>
      </div>

      <div class="form-group">
        <label>URL de Imagen</label>
        <input formControlName="imagenUrl" type="text" placeholder="/img/placehorlder.png" />
      </div>
    </form>

    <div class="modal-actions">
      <button class="btn cancel" (click)="cerrarModal()">Cancelar</button>
      <button class="btn save" (click)="guardarProducto()" [disabled]="formProducto.invalid">
        {{ idEdicion ? 'Actualizar' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalStock">
  <div class="modal-container" style="width: 400px">
    <h2 class="modal-title">Gesti√≥n de Stock</h2>

    <div
      style="
        text-align: center;
        margin-bottom: 20px;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 8px;
      "
    >
      <p style="margin: 0; color: #666; font-size: 0.9em">Producto</p>
      <strong style="font-size: 1.1em">{{ productoSeleccionado?.nombre }}</strong>
      <div style="margin-top: 8px; font-size: 0.9em">
        Stock Actual: <strong>{{ productoSeleccionado?.stockActual }}</strong>
      </div>
    </div>

    <div class="modal-form">
      <div class="form-group">
        <label>Cantidad:</label>
        <input
          [formControl]="cantidadStockControl"
          type="number"
          placeholder="Ej. 10"
          min="1"
          autofocus
          style="text-align: center; font-size: 1.2em; padding: 12px"
        />

        <small
          *ngIf="cantidadStockControl.invalid && cantidadStockControl.touched"
          style="color: red; text-align: center; display: block; margin-top: 5px"
        >
          Ingrese una cantidad v√°lida mayor a 0
        </small>
      </div>
    </div>

    <div class="modal-actions" style="justify-content: space-between; gap: 10px">
      <button class="btn cancel" (click)="cerrarModalStock()" style="flex: 1">Cancelar</button>

      <button
        class="btn btn-danger"
        (click)="guardarAjusteStock('RESTAR')"
        [disabled]="cantidadStockControl.invalid"
        style="flex: 1"
      >
        ‚ûñ Retirar
      </button>

      <button
        class="btn btn-success"
        (click)="guardarAjusteStock('SUMAR')"
        [disabled]="cantidadStockControl.invalid"
        style="flex: 1"
      >
        ‚ûï Agregar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalVenta">
  <div class="modal-container" style="width: 700px">
    <h2 class="modal-title">Registrar Venta Local / Interna</h2>

    <div class="modal-form">
      <div class="form-group">
        <label>ID Cliente / Distribuidor:</label>
        <input
          [formControl]="idClienteInterno"
          type="number"
          placeholder="ID del usuario comprador"
        />
      </div>

      <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee" />

      <div class="form-row" style="align-items: flex-end">
        <div class="form-group" style="flex: 2">
          <label>Producto:</label>
          <select [(ngModel)]="productoSeleccionadoId">
            <option [ngValue]="null">-- Seleccione --</option>
            <option *ngFor="let p of products" [ngValue]="p.id">
              {{ p.nombre }} (Stock: {{ p.stockActual }}) - S/ {{ p.precioInterno || p.precio }}
            </option>
          </select>
        </div>

        <div class="form-group" style="flex: 1">
          <label>Cant:</label>
          <input type="number" [(ngModel)]="cantidadSeleccionada" min="1" />
        </div>

        <div class="form-group">
          <button
            class="btn save"
            (click)="agregarItemVenta()"
            [disabled]="!productoSeleccionadoId"
          >
            + Agregar
          </button>
        </div>
      </div>

      <div
        style="
          margin-top: 20px;
          max-height: 200px;
          overflow-y: auto;
          border: 1px solid #eee;
          border-radius: 8px;
        "
      >
        <table class="products-table" style="min-width: 100%">
          <thead style="background: #f9f9f9">
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of itemsVenta; let i = index">
              <td style="text-align: left; padding: 10px">{{ item.nombre }}</td>
              <td>{{ item.cantidad }}</td>
              <td>S/ {{ item.subtotal | number : '1.2-2' }}</td>
              <td>
                <button class="btn-icon delete" (click)="eliminarItemVenta(i)">‚úï</button>
              </td>
            </tr>
            <tr *ngIf="itemsVenta.length === 0">
              <td colspan="4" style="text-align: center; padding: 15px; color: #999">
                Ning√∫n producto agregado a√∫n.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="text-align: right; margin-top: 15px; font-size: 1.2em">
        Total a Pagar:
        <strong>{{ totalVentaInterna | currency : 'S/. ' : 'symbol' : '1.2-2' }}</strong>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn cancel" (click)="cerrarModalVenta()">Cancelar</button>
      <button class="btn save" (click)="guardarVentaInterna()">Registrar Venta</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalUbicacion">
  <div class="modal-container" style="width: 400px">
    <h2 class="modal-title">
      Registrar
      {{
        nivelUbicacion === 'DEPTO'
          ? 'Departamento'
          : nivelUbicacion === 'PROV'
          ? 'Provincia'
          : 'Distrito'
      }}
    </h2>

    <p *ngIf="padreSeleccionado" style="text-align: center; color: #666; margin-bottom: 15px">
      En: <strong>{{ padreSeleccionado.nombre }}</strong>
    </p>

    <div class="modal-form">
      <div class="form-group">
        <label>Nombre:</label>
        <input
          [formControl]="nombreUbicacionControl"
          type="text"
          placeholder="Ej. Nuevo Lugar"
          autofocus
        />
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn cancel" (click)="cerrarModalUbicacion()">Cancelar</button>
      <button
        class="btn save"
        (click)="guardarUbicacion()"
        [disabled]="nombreUbicacionControl.invalid"
      >
        Guardar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalAgencia">
  <div class="modal-container" style="width: 350px">
    <h2 class="modal-title">Nueva Agencia</h2>
    <form [formGroup]="formAgencia" class="modal-form">
      <div class="form-group">
        <label>Nombre Comercial</label>
        <input formControlName="nombre" type="text" placeholder="Ej. Olva Courier" />
      </div>
    </form>
    <div class="modal-actions">
      <button class="btn cancel" (click)="mostrarModalAgencia = false">Cancelar</button>
      <button class="btn save" (click)="guardarAgencia()" [disabled]="formAgencia.invalid">
        Guardar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalTarifa">
  <div class="modal-container">
    <h2 class="modal-title">Nueva Ruta de Env√≠o</h2>
    <p style="text-align: center; color: #666">
      Agencia: <strong>{{ agenciaSeleccionada?.nombre }}</strong>
    </p>

    <form [formGroup]="formTarifa" class="modal-form">
      <div class="form-row">
        <div class="form-group small">
          <label>Departamento</label>
          <select formControlName="idDepartamento" (change)="onDeptoChange()">
            <option [ngValue]="null" disabled>-- Seleccione --</option>
            <option *ngFor="let d of deptosTarifa" [ngValue]="d.id">{{ d.nombre }}</option>
          </select>
        </div>
        <div class="form-group small">
          <label>Provincia</label>
          <select formControlName="idProvincia" (change)="onProvChange()">
            <option [ngValue]="null" disabled>-- Seleccione --</option>
            <option *ngFor="let p of provsTarifa" [ngValue]="p.id">{{ p.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Distrito Destino</label>
        <select formControlName="idDistrito">
          <option [ngValue]="null" disabled>-- Seleccione --</option>
          <option *ngFor="let d of distsTarifa" [ngValue]="d.id">{{ d.nombre }}</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group small">
          <label>Costo (S/)</label>
          <input type="number" formControlName="costoEnvio" min="0" placeholder="0.00" />
        </div>
        <div class="form-group small">
          <label>Tiempo (D√≠as)</label>
          <input type="number" formControlName="diasEstimados" min="1" placeholder="1" />
        </div>
      </div>
    </form>

    <div class="modal-actions">
      <button class="btn cancel" (click)="mostrarModalTarifa = false">Cancelar</button>
      <button class="btn save" (click)="guardarTarifa()" [disabled]="formTarifa.invalid">
        Crear Tarifa
      </button>
    </div>
  </div>
</div>

<div *ngIf="mostrarModalPedido && pedidoSeleccionado" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Pedido #{{ pedidoSeleccionado.id }}</h3>
      <button (click)="mostrarModalPedido = false" class="btn-close">&times;</button>
    </div>

    <div class="modal-body">
      <div class="info-grid">
        <div class="info-card">
          <label>Cliente</label>
          <div class="info-value">
            {{ pedidoSeleccionado.nombresUsuario }} {{ pedidoSeleccionado.apellidosUsuario }}
          </div>
          <div class="info-sub">{{ pedidoSeleccionado.emailUsuario }}</div>
        </div>

        <div class="info-card">
          <label>Resumen Financiero</label>
          <div class="info-row">
            <span>Estado:</span>
            <span
              [class.text-danger]="pedidoSeleccionado.estado === 'CANCELADO'"
              [class.text-success]="pedidoSeleccionado.estado !== 'CANCELADO'"
            >
              {{ pedidoSeleccionado.estado }}
            </span>
          </div>
          <div class="info-row total-row">
            <span>Total:</span>
            <span>S/ {{ pedidoSeleccionado.total | number : '1.2-2' }}</span>
          </div>
        </div>
      </div>

      <h4 class="modal-section-title">Productos Solicitados</h4>
      <table class="modal-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-center">Cant.</th>
            <th class="text-right">Precio Unit.</th>
            <th class="text-right">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of pedidoSeleccionado.detalles">
            <td>{{ item.nombreProducto }}</td>
            <td class="text-center">{{ item.cantidad }}</td>
            <td class="text-right">S/ {{ item.precioUnitario | number : '1.2-2' }}</td>
            <td class="text-right fw-bold">S/ {{ item.subtotal | number : '1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal-footer">
      <button (click)="mostrarModalPedido = false" class="btn-secondary">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalCategoria">
  <div class="modal-container" style="width: 400px">
    <h2 class="modal-title">
      {{ categoriaSeleccionada ? 'Editar Categor√≠a' : 'Nueva Categor√≠a' }}
    </h2>

    <form [formGroup]="formCategoria" class="modal-form">
      <div class="form-group">
        <label>Nombre</label>
        <input
          formControlName="nombre"
          type="text"
          placeholder="Ej. Mieles, Prop√≥leos..."
          autofocus
        />
      </div>

      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea formControlName="descripcion" rows="3" placeholder="Descripci√≥n..."></textarea>
      </div>
    </form>

    <div class="modal-actions">
      <button class="btn cancel" (click)="cerrarModalCategoria()">Cancelar</button>
      <button class="btn save" (click)="guardarCategoria()" [disabled]="formCategoria.invalid">
        {{ categoriaSeleccionada ? 'Actualizar' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>
