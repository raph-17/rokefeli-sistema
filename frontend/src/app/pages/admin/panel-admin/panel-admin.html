<app-header-admin></app-header-admin>

<main>
  <div class="dashboard-container">
    <div class="metrics" *ngIf="activeTab === 'productos'">
      <div class="card">
        <h3>Total Cat√°logo</h3>
        <span class="value">{{ products.length }}</span>
      </div>
      <div class="card">
        <h3>Activos (Venta)</h3>
        <span class="value" style="color: #28a745">{{ productosActivos }}</span>
      </div>
      <div class="card">
        <h3>Descontinuados</h3>
        <span class="value" style="color: #6c757d">{{ productosInactivos }}</span>
      </div>
      <div class="card">
        <h3>Categor√≠as</h3>
        <span class="value">{{ categorias.length }}</span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'inventario'">
      <div class="card">
        <h3>Total Productos</h3>
        <span class="value">{{ products.length }}</span>
      </div>
      <div class="card">
        <h3>Stock Cr√≠tico</h3>
        <span class="value" [class.alert]="stockBajo > 0">{{ stockBajo }}</span>
      </div>
      <div class="card">
        <h3>Stock Saludable</h3>
        <span class="value" style="color: #1e8e3e">{{ products.length - stockBajo }}</span>
      </div>
      <div class="card">
        <h3>Estado Almac√©n</h3>
        <span class="value" style="font-size: 20px">{{
          stockBajo > 0 ? '‚ö†Ô∏è Atenci√≥n' : '‚úÖ √ìptimo'
        }}</span>
      </div>
    </div>

    <div class="metrics" *ngIf="activeTab === 'ventas'">
      <div class="card">
        <h3>Ingresos Totales</h3>
        <span class="value">{{ ingresosTotales | currency : 'S/. ' : 'symbol' : '1.2-2' }}</span>
      </div>
      <div class="card">
        <h3>Total Transacciones</h3>
        <span class="value">{{ ventasTotales }}</span>
      </div>
      <div class="card">
        <h3>Ventas Procesadas</h3>
        <span class="value" [style.color]="ventasProcesadas > 0 ? '#28a745' : '#666'">
          {{ ventasProcesadas }}
        </span>
      </div>
      <div class="card">
        <h3>Promedio por Venta</h3>
        <span class="value">{{ ticketPromedio | currency : 'S/. ' : 'symbol' : '1.0-0' }}</span>
      </div>
    </div>

    <div *ngIf="cargando" class="loading">Cargando datos...</div>

    <div class="tabs">
      <button
        class="tab"
        [class.active]="activeTab === 'productos'"
        (click)="cambiarTab('productos')"
      >
        üì¶ Productos
      </button>

      <button
        class="tab"
        [class.active]="activeTab === 'inventario'"
        (click)="cambiarTab('inventario')"
      >
        üìä Inventario
      </button>

      <button class="tab" [class.active]="activeTab === 'ventas'" (click)="cambiarTab('ventas')">
        üí∞ Ventas
      </button>
    </div>

    <div *ngIf="activeTab === 'productos'" class="table-section">
      <div class="table-header">
        <h3>Listado de Productos</h3>
        <button class="btn add" (click)="abrirModalAgregarProducto()">+ Nuevo Producto</button>
      </div>

      <div class="filters-bar">
        <div class="filter-group">
          <input
            type="text"
            placeholder="Buscar producto por nombre..."
            [(ngModel)]="filtroNombre"
            (keyup.enter)="filtrarProductos()"
          />
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroCategoria" (change)="filtrarProductos()">
            <option [ngValue]="null">Todas las Categor√≠as</option>
            <option *ngFor="let cat of categorias" [ngValue]="cat.id">
              {{ cat.nombre }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroEstado" (change)="filtrarProductos()">
            <option value="">Todos los Estados</option>
            <option value="ACTIVO">Activo</option>
            <option value="DESCONTINUADO">Descontinuado</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn-filter clear" (click)="limpiarFiltros()" title="Limpiar filtros">
            ‚úï
          </button>
        </div>
      </div>

      <div *ngIf="cargando" class="loading">Cargando datos...</div>

      <table class="products-table" *ngIf="!cargando">
        <thead>
          <tr>
            <th>Img</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of products">
            <td>
              <img
                [src]="p.imagenUrl"
                onerror="this.src='/img/placeholder.png'"
                class="table-img"
              />
            </td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.categoriaNombre || 'Sin Cat.' }}</td>
            <td>{{ p.precio | currency : 'S/. ' : 'symbol' : '1.2-2' }}</td>
            <td>
              <span [class.text-danger]="p.stockActual < p.stockMinimo">
                {{ p.stockActual }}
              </span>
            </td>
            <td>
              <span class="status" [ngClass]="p.estado === 'ACTIVO' ? 'normal' : 'low'">
                {{ p.estado }}
              </span>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button
                  class="btn-icon btn-blue"
                  (click)="abrirModalStock(p)"
                  title="Ajustar Stock"
                >
                  üì¶
                </button>

                <button
                  class="btn-icon btn-yellow"
                  (click)="abrirModalEditarProducto(p)"
                  title="Editar"
                >
                  ‚úèÔ∏è
                </button>

                <button
                  class="btn-icon btn-gray"
                  *ngIf="p.estado === 'ACTIVO'"
                  (click)="desactivarProducto(p.id)"
                  title="Desactivar"
                >
                  üîí
                </button>

                <button
                  class="btn-icon btn-green"
                  *ngIf="p.estado !== 'ACTIVO'"
                  (click)="activarProducto(p.id)"
                  title="Activar"
                >
                  üîì
                </button>

                <button class="btn-icon btn-red" (click)="eliminarProducto(p.id)" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'inventario'" class="table-section">
      <div class="table-header">
        <h3>Control de Stock</h3>

        <label class="toggle-filter" [class.active]="mostrarSoloBajoStock">
          <input type="checkbox" [(ngModel)]="mostrarSoloBajoStock" />
          ‚ö†Ô∏è Ver solo Stock Bajo
        </label>
      </div>

      <table class="products-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock Actual</th>
            <th>M√≠nimo Req.</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of inventarioFiltrado">
            <td>{{ p.nombre }}</td>
            <td style="font-weight: bold; font-size: 1.1em">
              <span [class.text-danger]="p.stockActual < p.stockMinimo">
                {{ p.stockActual }}
              </span>
            </td>
            <td>{{ p.stockMinimo }}</td>
            <td>
              <span class="status" [ngClass]="p.stockActual < p.stockMinimo ? 'low' : 'normal'">
                {{ p.stockActual < p.stockMinimo ? 'REPONER' : 'OK' }}
              </span>
            </td>
          </tr>

          <tr *ngIf="inventarioFiltrado.length === 0 && mostrarSoloBajoStock">
            <td colspan="4" style="text-align: center; padding: 20px; color: #1e8e3e">
              ‚úÖ ¬°Todo est√° en orden! No hay productos con stock bajo.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab === 'ventas'" class="table-section">
      <div class="table-header">
        <h3>Historial de Transacciones</h3>

        <button class="btn add" (click)="abrirModalVenta()">+ Nueva Venta Interna</button>
      </div>

      <div class="filters-bar">
        <div class="filter-group">
          <input
            type="text"
            placeholder="Buscar por DNI Cliente..."
            [(ngModel)]="filtroVentaDni"
            (keyup.enter)="filtrarVentas()"
          />
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroVentaCanal" (change)="filtrarVentas()">
            <option value="">Todos los Canales</option>
            <option value="ONLINE">Online (Web)</option>
            <option value="INTERNO">Interno (Local/Distribuidor)</option>
          </select>
        </div>

        <div class="filter-group">
          <select [(ngModel)]="filtroVentaEstado" (change)="filtrarVentas()">
            <option value="">Todos los Estados</option>
            <option value="PAGADA">Pagada</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="PROCESADA">Procesada</option>
            <option value="CANCELADA">Cancelada</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn-filter clear" (click)="limpiarFiltrosVentas()">‚úï</button>
        </div>
      </div>
      <table class="products-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente (DNI)</th>
            <th>Canal</th>
            <th>Total</th>
            <th>Fecha</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let v of ventasFiltradas">
            <td>#{{ v.id }}</td>

            <td>
              <div style="display: flex; flex-direction: column">
                <span style="font-weight: 500">{{
                  v.nombresUsuario + ' ' + v.apellidosUsuario || 'Cliente'
                }}</span>
                <small style="color: #d48300; font-weight: bold">
                  {{ v.dniUsuario || 'S/N' }}
                </small>
              </div>
            </td>

            <td>
              <span style="font-size: 11px; padding: 2px 6px; background: #eee; border-radius: 4px">
                {{ v.canal }}
              </span>
            </td>

            <td style="font-weight: bold">
              {{ v.montoTotal | currency : 'S/. ' : 'symbol' : '1.2-2' }}
            </td>
            <td>{{ v.fecha | date : 'short' }}</td>
            <td>
              <span
                class="status"
                [ngClass]="v.estado === 'PAGADA' || v.estado === 'PROCESADA' ? 'normal' : 'low'"
              >
                {{ v.estado }}
              </span>
            </td>
          </tr>
          <tr *ngIf="ventasFiltradas.length === 0">
            <td colspan="6" style="text-align: center; padding: 20px; color: #666">
              No se encontraron ventas con estos filtros.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<div class="modal-overlay" *ngIf="mostrarModal">
  <div class="modal-container">
    <h2 class="modal-title">
      {{ idEdicion ? 'Editar Producto' : 'Registrar Nuevo Producto' }}
    </h2>

    <form [formGroup]="formProducto" class="modal-form">
      <div class="form-group">
        <label>Nombre del Producto</label>
        <input formControlName="nombre" type="text" placeholder="Ej. Miel de Eucalipto" />
      </div>

      <div class="form-group">
        <label>Categor√≠a</label>
        <select formControlName="idCategoria">
          <option [ngValue]="''" disabled>-- Seleccione --</option>

          <option *ngFor="let cat of categorias" [ngValue]="cat.id">
            {{ cat.nombre }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea formControlName="descripcion" rows="3"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group small">
          <label>Precio (S/)</label>
          <input formControlName="precio" type="number" min="0" />
        </div>
        <div class="form-group small">
          <label>Precio Interno (S/)</label>
          <input formControlName="precioInterno" type="number" min="0" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group small">
          <label>Stock Inicial</label>
          <input formControlName="stockActual" type="number" min="0" />
        </div>
        <div class="form-group small">
          <label>Stock M√≠nimo (Alerta)</label>
          <input formControlName="stockMinimo" type="number" min="0" />
        </div>
      </div>

      <div class="form-group">
        <label>URL de Imagen</label>
        <input formControlName="imagenUrl" type="text" placeholder="https://..." />
      </div>
    </form>

    <div class="modal-actions">
      <button class="btn cancel" (click)="cerrarModal()">Cancelar</button>
      <button class="btn save" (click)="guardarProducto()" [disabled]="formProducto.invalid">
        {{ idEdicion ? 'Actualizar' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalStock">
  <div class="modal-container" style="width: 400px">
    <h2 class="modal-title">Gesti√≥n de Stock</h2>

    <div
      style="
        text-align: center;
        margin-bottom: 20px;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 8px;
      "
    >
      <p style="margin: 0; color: #666; font-size: 0.9em">Producto</p>
      <strong style="font-size: 1.1em">{{ productoSeleccionado?.nombre }}</strong>
      <div style="margin-top: 8px; font-size: 0.9em">
        Stock Actual: <strong>{{ productoSeleccionado?.stockActual }}</strong>
      </div>
    </div>

    <div class="modal-form">
      <div class="form-group">
        <label>Cantidad:</label>
        <input
          [formControl]="cantidadStockControl"
          type="number"
          placeholder="Ej. 10"
          min="1"
          autofocus
          style="text-align: center; font-size: 1.2em; padding: 12px"
        />

        <small
          *ngIf="cantidadStockControl.invalid && cantidadStockControl.touched"
          style="color: red; text-align: center; display: block; margin-top: 5px"
        >
          Ingrese una cantidad v√°lida mayor a 0
        </small>
      </div>
    </div>

    <div class="modal-actions" style="justify-content: space-between; gap: 10px">
      <button class="btn cancel" (click)="cerrarModalStock()" style="flex: 1">Cancelar</button>

      <button
        class="btn btn-danger"
        (click)="guardarAjusteStock('RESTAR')"
        [disabled]="cantidadStockControl.invalid"
        style="flex: 1"
      >
        ‚ûñ Retirar
      </button>

      <button
        class="btn btn-success"
        (click)="guardarAjusteStock('SUMAR')"
        [disabled]="cantidadStockControl.invalid"
        style="flex: 1"
      >
        ‚ûï Agregar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalVenta">
  <div class="modal-container" style="width: 700px">
    <h2 class="modal-title">Registrar Venta Local / Interna</h2>

    <div class="modal-form">
      <div class="form-group">
        <label>ID Cliente / Distribuidor:</label>
        <input
          [formControl]="idClienteInterno"
          type="number"
          placeholder="ID del usuario comprador"
        />
      </div>

      <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee" />

      <div class="form-row" style="align-items: flex-end">
        <div class="form-group" style="flex: 2">
          <label>Producto:</label>
          <select [(ngModel)]="productoSeleccionadoId">
            <option [ngValue]="null">-- Seleccione --</option>
            <option *ngFor="let p of products" [ngValue]="p.id">
              {{ p.nombre }} (Stock: {{ p.stockActual }}) - S/ {{ p.precioInterno || p.precio }}
            </option>
          </select>
        </div>

        <div class="form-group" style="flex: 1">
          <label>Cant:</label>
          <input type="number" [(ngModel)]="cantidadSeleccionada" min="1" />
        </div>

        <div class="form-group">
          <button
            class="btn save"
            (click)="agregarItemVenta()"
            [disabled]="!productoSeleccionadoId"
          >
            + Agregar
          </button>
        </div>
      </div>

      <div
        style="
          margin-top: 20px;
          max-height: 200px;
          overflow-y: auto;
          border: 1px solid #eee;
          border-radius: 8px;
        "
      >
        <table class="products-table" style="min-width: 100%">
          <thead style="background: #f9f9f9">
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of itemsVenta; let i = index">
              <td style="text-align: left; padding: 10px">{{ item.nombre }}</td>
              <td>{{ item.cantidad }}</td>
              <td>S/ {{ item.subtotal | number : '1.2-2' }}</td>
              <td>
                <button class="btn-icon delete" (click)="eliminarItemVenta(i)">‚úï</button>
              </td>
            </tr>
            <tr *ngIf="itemsVenta.length === 0">
              <td colspan="4" style="text-align: center; padding: 15px; color: #999">
                Ning√∫n producto agregado a√∫n.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="text-align: right; margin-top: 15px; font-size: 1.2em">
        Total a Pagar:
        <strong>{{ totalVentaInterna | currency : 'S/. ' : 'symbol' : '1.2-2' }}</strong>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn cancel" (click)="cerrarModalVenta()">Cancelar</button>
      <button class="btn save" (click)="guardarVentaInterna()">Registrar Venta</button>
    </div>
  </div>
</div>
